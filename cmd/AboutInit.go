package cmd

import (
	"fmt"
	"log"
	"os"
	"strings"

	libvirtxml "libvirt.org/libvirt-go-xml"
)

func GenNetwork(NetAddr string) (netxml string) {
	netcfg := &libvirtxml.Network{
		Name: "virt-go-net",
		Forward: &libvirtxml.NetworkForward{
			Mode: "nat", NAT: &libvirtxml.NetworkForwardNAT{
				Addresses: []libvirtxml.NetworkForwardNATAddress{},
				Ports:     []libvirtxml.NetworkForwardNATPort{{Start: uint(1024), End: uint(65535)}},
			},
		},
		IPs: []libvirtxml.NetworkIP{
			{
				Address: NetAddr + ".1", Family: "ipv4", Prefix: uint(24),
				DHCP: &libvirtxml.NetworkDHCP{
					Ranges: []libvirtxml.NetworkDHCPRange{
						{Start: NetAddr + ".2", End: NetAddr + ".254"},
					},
					Hosts: []libvirtxml.NetworkDHCPHost{
						// 02 - 99
						{MAC: "02:00:AA:AA:AA:02", IP: NetAddr + ".2"},
						{MAC: "02:00:AA:AA:AA:03", IP: NetAddr + ".3"},
						{MAC: "02:00:AA:AA:AA:04", IP: NetAddr + ".4"},
						{MAC: "02:00:AA:AA:AA:05", IP: NetAddr + ".5"},
						{MAC: "02:00:AA:AA:AA:06", IP: NetAddr + ".6"},
						{MAC: "02:00:AA:AA:AA:07", IP: NetAddr + ".7"},
						{MAC: "02:00:AA:AA:AA:08", IP: NetAddr + ".8"},
						{MAC: "02:00:AA:AA:AA:09", IP: NetAddr + ".9"},
						{MAC: "02:00:AA:AA:AA:10", IP: NetAddr + ".10"},
						{MAC: "02:00:AA:AA:AA:11", IP: NetAddr + ".11"},
						{MAC: "02:00:AA:AA:AA:12", IP: NetAddr + ".12"},
						{MAC: "02:00:AA:AA:AA:13", IP: NetAddr + ".13"},
						{MAC: "02:00:AA:AA:AA:14", IP: NetAddr + ".14"},
						{MAC: "02:00:AA:AA:AA:15", IP: NetAddr + ".15"},
						{MAC: "02:00:AA:AA:AA:16", IP: NetAddr + ".16"},
						{MAC: "02:00:AA:AA:AA:17", IP: NetAddr + ".17"},
						{MAC: "02:00:AA:AA:AA:18", IP: NetAddr + ".18"},
						{MAC: "02:00:AA:AA:AA:19", IP: NetAddr + ".19"},
						{MAC: "02:00:AA:AA:AA:20", IP: NetAddr + ".20"},
						{MAC: "02:00:AA:AA:AA:21", IP: NetAddr + ".21"},
						{MAC: "02:00:AA:AA:AA:22", IP: NetAddr + ".22"},
						{MAC: "02:00:AA:AA:AA:23", IP: NetAddr + ".23"},
						{MAC: "02:00:AA:AA:AA:24", IP: NetAddr + ".24"},
						{MAC: "02:00:AA:AA:AA:25", IP: NetAddr + ".25"},
						{MAC: "02:00:AA:AA:AA:26", IP: NetAddr + ".26"},
						{MAC: "02:00:AA:AA:AA:27", IP: NetAddr + ".27"},
						{MAC: "02:00:AA:AA:AA:28", IP: NetAddr + ".28"},
						{MAC: "02:00:AA:AA:AA:29", IP: NetAddr + ".29"},
						{MAC: "02:00:AA:AA:AA:30", IP: NetAddr + ".30"},
						{MAC: "02:00:AA:AA:AA:31", IP: NetAddr + ".31"},
						{MAC: "02:00:AA:AA:AA:32", IP: NetAddr + ".32"},
						{MAC: "02:00:AA:AA:AA:33", IP: NetAddr + ".33"},
						{MAC: "02:00:AA:AA:AA:34", IP: NetAddr + ".34"},
						{MAC: "02:00:AA:AA:AA:35", IP: NetAddr + ".35"},
						{MAC: "02:00:AA:AA:AA:36", IP: NetAddr + ".36"},
						{MAC: "02:00:AA:AA:AA:37", IP: NetAddr + ".37"},
						{MAC: "02:00:AA:AA:AA:38", IP: NetAddr + ".38"},
						{MAC: "02:00:AA:AA:AA:39", IP: NetAddr + ".39"},
						{MAC: "02:00:AA:AA:AA:40", IP: NetAddr + ".40"},
						{MAC: "02:00:AA:AA:AA:41", IP: NetAddr + ".41"},
						{MAC: "02:00:AA:AA:AA:42", IP: NetAddr + ".42"},
						{MAC: "02:00:AA:AA:AA:43", IP: NetAddr + ".43"},
						{MAC: "02:00:AA:AA:AA:44", IP: NetAddr + ".44"},
						{MAC: "02:00:AA:AA:AA:45", IP: NetAddr + ".45"},
						{MAC: "02:00:AA:AA:AA:46", IP: NetAddr + ".46"},
						{MAC: "02:00:AA:AA:AA:47", IP: NetAddr + ".47"},
						{MAC: "02:00:AA:AA:AA:48", IP: NetAddr + ".48"},
						{MAC: "02:00:AA:AA:AA:49", IP: NetAddr + ".49"},
						{MAC: "02:00:AA:AA:AA:50", IP: NetAddr + ".50"},
						{MAC: "02:00:AA:AA:AA:51", IP: NetAddr + ".51"},
						{MAC: "02:00:AA:AA:AA:52", IP: NetAddr + ".52"},
						{MAC: "02:00:AA:AA:AA:53", IP: NetAddr + ".53"},
						{MAC: "02:00:AA:AA:AA:54", IP: NetAddr + ".54"},
						{MAC: "02:00:AA:AA:AA:55", IP: NetAddr + ".55"},
						{MAC: "02:00:AA:AA:AA:56", IP: NetAddr + ".56"},
						{MAC: "02:00:AA:AA:AA:57", IP: NetAddr + ".57"},
						{MAC: "02:00:AA:AA:AA:58", IP: NetAddr + ".58"},
						{MAC: "02:00:AA:AA:AA:59", IP: NetAddr + ".59"},
						{MAC: "02:00:AA:AA:AA:60", IP: NetAddr + ".60"},
						{MAC: "02:00:AA:AA:AA:61", IP: NetAddr + ".61"},
						{MAC: "02:00:AA:AA:AA:62", IP: NetAddr + ".62"},
						{MAC: "02:00:AA:AA:AA:63", IP: NetAddr + ".63"},
						{MAC: "02:00:AA:AA:AA:64", IP: NetAddr + ".64"},
						{MAC: "02:00:AA:AA:AA:65", IP: NetAddr + ".65"},
						{MAC: "02:00:AA:AA:AA:66", IP: NetAddr + ".66"},
						{MAC: "02:00:AA:AA:AA:67", IP: NetAddr + ".67"},
						{MAC: "02:00:AA:AA:AA:68", IP: NetAddr + ".68"},
						{MAC: "02:00:AA:AA:AA:69", IP: NetAddr + ".69"},
						{MAC: "02:00:AA:AA:AA:70", IP: NetAddr + ".70"},
						{MAC: "02:00:AA:AA:AA:71", IP: NetAddr + ".71"},
						{MAC: "02:00:AA:AA:AA:72", IP: NetAddr + ".72"},
						{MAC: "02:00:AA:AA:AA:73", IP: NetAddr + ".73"},
						{MAC: "02:00:AA:AA:AA:74", IP: NetAddr + ".74"},
						{MAC: "02:00:AA:AA:AA:75", IP: NetAddr + ".75"},
						{MAC: "02:00:AA:AA:AA:76", IP: NetAddr + ".76"},
						{MAC: "02:00:AA:AA:AA:77", IP: NetAddr + ".77"},
						{MAC: "02:00:AA:AA:AA:78", IP: NetAddr + ".78"},
						{MAC: "02:00:AA:AA:AA:79", IP: NetAddr + ".79"},
						{MAC: "02:00:AA:AA:AA:80", IP: NetAddr + ".80"},
						{MAC: "02:00:AA:AA:AA:81", IP: NetAddr + ".81"},
						{MAC: "02:00:AA:AA:AA:82", IP: NetAddr + ".82"},
						{MAC: "02:00:AA:AA:AA:83", IP: NetAddr + ".83"},
						{MAC: "02:00:AA:AA:AA:84", IP: NetAddr + ".84"},
						{MAC: "02:00:AA:AA:AA:85", IP: NetAddr + ".85"},
						{MAC: "02:00:AA:AA:AA:86", IP: NetAddr + ".86"},
						{MAC: "02:00:AA:AA:AA:87", IP: NetAddr + ".87"},
						{MAC: "02:00:AA:AA:AA:88", IP: NetAddr + ".88"},
						{MAC: "02:00:AA:AA:AA:89", IP: NetAddr + ".89"},
						{MAC: "02:00:AA:AA:AA:90", IP: NetAddr + ".90"},
						{MAC: "02:00:AA:AA:AA:91", IP: NetAddr + ".91"},
						{MAC: "02:00:AA:AA:AA:92", IP: NetAddr + ".92"},
						{MAC: "02:00:AA:AA:AA:93", IP: NetAddr + ".93"},
						{MAC: "02:00:AA:AA:AA:94", IP: NetAddr + ".94"},
						{MAC: "02:00:AA:AA:AA:95", IP: NetAddr + ".95"},
						{MAC: "02:00:AA:AA:AA:96", IP: NetAddr + ".96"},
						{MAC: "02:00:AA:AA:AA:97", IP: NetAddr + ".97"},
						{MAC: "02:00:AA:AA:AA:98", IP: NetAddr + ".98"},
						{MAC: "02:00:AA:AA:AA:99", IP: NetAddr + ".99"},

						// 100 - 199
						{MAC: "02:00:AA:AA:AB:00", IP: NetAddr + ".100"},
						{MAC: "02:00:AA:AA:AB:01", IP: NetAddr + ".101"},
						{MAC: "02:00:AA:AA:AB:02", IP: NetAddr + ".102"},
						{MAC: "02:00:AA:AA:AB:03", IP: NetAddr + ".103"},
						{MAC: "02:00:AA:AA:AB:04", IP: NetAddr + ".104"},
						{MAC: "02:00:AA:AA:AB:05", IP: NetAddr + ".105"},
						{MAC: "02:00:AA:AA:AB:06", IP: NetAddr + ".106"},
						{MAC: "02:00:AA:AA:AB:07", IP: NetAddr + ".107"},
						{MAC: "02:00:AA:AA:AB:08", IP: NetAddr + ".108"},
						{MAC: "02:00:AA:AA:AB:09", IP: NetAddr + ".109"},
						{MAC: "02:00:AA:AA:AB:10", IP: NetAddr + ".110"},
						{MAC: "02:00:AA:AA:AB:11", IP: NetAddr + ".111"},
						{MAC: "02:00:AA:AA:AB:12", IP: NetAddr + ".112"},
						{MAC: "02:00:AA:AA:AB:13", IP: NetAddr + ".113"},
						{MAC: "02:00:AA:AA:AB:14", IP: NetAddr + ".114"},
						{MAC: "02:00:AA:AA:AB:15", IP: NetAddr + ".115"},
						{MAC: "02:00:AA:AA:AB:16", IP: NetAddr + ".116"},
						{MAC: "02:00:AA:AA:AB:17", IP: NetAddr + ".117"},
						{MAC: "02:00:AA:AA:AB:18", IP: NetAddr + ".118"},
						{MAC: "02:00:AA:AA:AB:19", IP: NetAddr + ".119"},
						{MAC: "02:00:AA:AA:AB:20", IP: NetAddr + ".120"},
						{MAC: "02:00:AA:AA:AB:21", IP: NetAddr + ".121"},
						{MAC: "02:00:AA:AA:AB:22", IP: NetAddr + ".122"},
						{MAC: "02:00:AA:AA:AB:23", IP: NetAddr + ".123"},
						{MAC: "02:00:AA:AA:AB:24", IP: NetAddr + ".124"},
						{MAC: "02:00:AA:AA:AB:25", IP: NetAddr + ".125"},
						{MAC: "02:00:AA:AA:AB:26", IP: NetAddr + ".126"},
						{MAC: "02:00:AA:AA:AB:27", IP: NetAddr + ".127"},
						{MAC: "02:00:AA:AA:AB:28", IP: NetAddr + ".128"},
						{MAC: "02:00:AA:AA:AB:29", IP: NetAddr + ".129"},
						{MAC: "02:00:AA:AA:AB:30", IP: NetAddr + ".130"},
						{MAC: "02:00:AA:AA:AB:31", IP: NetAddr + ".131"},
						{MAC: "02:00:AA:AA:AB:32", IP: NetAddr + ".132"},
						{MAC: "02:00:AA:AA:AB:33", IP: NetAddr + ".133"},
						{MAC: "02:00:AA:AA:AB:34", IP: NetAddr + ".134"},
						{MAC: "02:00:AA:AA:AB:35", IP: NetAddr + ".135"},
						{MAC: "02:00:AA:AA:AB:36", IP: NetAddr + ".136"},
						{MAC: "02:00:AA:AA:AB:37", IP: NetAddr + ".137"},
						{MAC: "02:00:AA:AA:AB:38", IP: NetAddr + ".138"},
						{MAC: "02:00:AA:AA:AB:39", IP: NetAddr + ".139"},
						{MAC: "02:00:AA:AA:AB:40", IP: NetAddr + ".140"},
						{MAC: "02:00:AA:AA:AB:41", IP: NetAddr + ".141"},
						{MAC: "02:00:AA:AA:AB:42", IP: NetAddr + ".142"},
						{MAC: "02:00:AA:AA:AB:43", IP: NetAddr + ".143"},
						{MAC: "02:00:AA:AA:AB:44", IP: NetAddr + ".144"},
						{MAC: "02:00:AA:AA:AB:45", IP: NetAddr + ".145"},
						{MAC: "02:00:AA:AA:AB:46", IP: NetAddr + ".146"},
						{MAC: "02:00:AA:AA:AB:47", IP: NetAddr + ".147"},
						{MAC: "02:00:AA:AA:AB:48", IP: NetAddr + ".148"},
						{MAC: "02:00:AA:AA:AB:49", IP: NetAddr + ".149"},
						{MAC: "02:00:AA:AA:AB:50", IP: NetAddr + ".150"},
						{MAC: "02:00:AA:AA:AB:51", IP: NetAddr + ".151"},
						{MAC: "02:00:AA:AA:AB:52", IP: NetAddr + ".152"},
						{MAC: "02:00:AA:AA:AB:53", IP: NetAddr + ".153"},
						{MAC: "02:00:AA:AA:AB:54", IP: NetAddr + ".154"},
						{MAC: "02:00:AA:AA:AB:55", IP: NetAddr + ".155"},
						{MAC: "02:00:AA:AA:AB:56", IP: NetAddr + ".156"},
						{MAC: "02:00:AA:AA:AB:57", IP: NetAddr + ".157"},
						{MAC: "02:00:AA:AA:AB:58", IP: NetAddr + ".158"},
						{MAC: "02:00:AA:AA:AB:59", IP: NetAddr + ".159"},
						{MAC: "02:00:AA:AA:AB:60", IP: NetAddr + ".160"},
						{MAC: "02:00:AA:AA:AB:61", IP: NetAddr + ".161"},
						{MAC: "02:00:AA:AA:AB:62", IP: NetAddr + ".162"},
						{MAC: "02:00:AA:AA:AB:63", IP: NetAddr + ".163"},
						{MAC: "02:00:AA:AA:AB:64", IP: NetAddr + ".164"},
						{MAC: "02:00:AA:AA:AB:65", IP: NetAddr + ".165"},
						{MAC: "02:00:AA:AA:AB:66", IP: NetAddr + ".166"},
						{MAC: "02:00:AA:AA:AB:67", IP: NetAddr + ".167"},
						{MAC: "02:00:AA:AA:AB:68", IP: NetAddr + ".168"},
						{MAC: "02:00:AA:AA:AB:69", IP: NetAddr + ".169"},
						{MAC: "02:00:AA:AA:AB:70", IP: NetAddr + ".170"},
						{MAC: "02:00:AA:AA:AB:71", IP: NetAddr + ".171"},
						{MAC: "02:00:AA:AA:AB:72", IP: NetAddr + ".172"},
						{MAC: "02:00:AA:AA:AB:73", IP: NetAddr + ".173"},
						{MAC: "02:00:AA:AA:AB:74", IP: NetAddr + ".174"},
						{MAC: "02:00:AA:AA:AB:75", IP: NetAddr + ".175"},
						{MAC: "02:00:AA:AA:AB:76", IP: NetAddr + ".176"},
						{MAC: "02:00:AA:AA:AB:77", IP: NetAddr + ".177"},
						{MAC: "02:00:AA:AA:AB:78", IP: NetAddr + ".178"},
						{MAC: "02:00:AA:AA:AB:79", IP: NetAddr + ".179"},
						{MAC: "02:00:AA:AA:AB:80", IP: NetAddr + ".180"},
						{MAC: "02:00:AA:AA:AB:81", IP: NetAddr + ".181"},
						{MAC: "02:00:AA:AA:AB:82", IP: NetAddr + ".182"},
						{MAC: "02:00:AA:AA:AB:83", IP: NetAddr + ".183"},
						{MAC: "02:00:AA:AA:AB:84", IP: NetAddr + ".184"},
						{MAC: "02:00:AA:AA:AB:85", IP: NetAddr + ".185"},
						{MAC: "02:00:AA:AA:AB:86", IP: NetAddr + ".186"},
						{MAC: "02:00:AA:AA:AB:87", IP: NetAddr + ".187"},
						{MAC: "02:00:AA:AA:AB:88", IP: NetAddr + ".188"},
						{MAC: "02:00:AA:AA:AB:89", IP: NetAddr + ".189"},
						{MAC: "02:00:AA:AA:AB:90", IP: NetAddr + ".190"},
						{MAC: "02:00:AA:AA:AB:91", IP: NetAddr + ".191"},
						{MAC: "02:00:AA:AA:AB:92", IP: NetAddr + ".192"},
						{MAC: "02:00:AA:AA:AB:93", IP: NetAddr + ".193"},
						{MAC: "02:00:AA:AA:AB:94", IP: NetAddr + ".194"},
						{MAC: "02:00:AA:AA:AB:95", IP: NetAddr + ".195"},
						{MAC: "02:00:AA:AA:AB:96", IP: NetAddr + ".196"},
						{MAC: "02:00:AA:AA:AB:97", IP: NetAddr + ".197"},
						{MAC: "02:00:AA:AA:AB:98", IP: NetAddr + ".198"},
						{MAC: "02:00:AA:AA:AB:99", IP: NetAddr + ".199"},

						// 200 - 254
						{MAC: "02:00:AA:AA:AC:00", IP: NetAddr + ".200"},
						{MAC: "02:00:AA:AA:AC:01", IP: NetAddr + ".201"},
						{MAC: "02:00:AA:AA:AC:02", IP: NetAddr + ".202"},
						{MAC: "02:00:AA:AA:AC:03", IP: NetAddr + ".203"},
						{MAC: "02:00:AA:AA:AC:04", IP: NetAddr + ".204"},
						{MAC: "02:00:AA:AA:AC:05", IP: NetAddr + ".205"},
						{MAC: "02:00:AA:AA:AC:06", IP: NetAddr + ".206"},
						{MAC: "02:00:AA:AA:AC:07", IP: NetAddr + ".207"},
						{MAC: "02:00:AA:AA:AC:08", IP: NetAddr + ".208"},
						{MAC: "02:00:AA:AA:AC:09", IP: NetAddr + ".209"},
						{MAC: "02:00:AA:AA:AC:10", IP: NetAddr + ".210"},
						{MAC: "02:00:AA:AA:AC:11", IP: NetAddr + ".211"},
						{MAC: "02:00:AA:AA:AC:12", IP: NetAddr + ".212"},
						{MAC: "02:00:AA:AA:AC:13", IP: NetAddr + ".213"},
						{MAC: "02:00:AA:AA:AC:14", IP: NetAddr + ".214"},
						{MAC: "02:00:AA:AA:AC:15", IP: NetAddr + ".215"},
						{MAC: "02:00:AA:AA:AC:16", IP: NetAddr + ".216"},
						{MAC: "02:00:AA:AA:AC:17", IP: NetAddr + ".217"},
						{MAC: "02:00:AA:AA:AC:18", IP: NetAddr + ".218"},
						{MAC: "02:00:AA:AA:AC:19", IP: NetAddr + ".219"},
						{MAC: "02:00:AA:AA:AC:20", IP: NetAddr + ".220"},
						{MAC: "02:00:AA:AA:AC:21", IP: NetAddr + ".221"},
						{MAC: "02:00:AA:AA:AC:22", IP: NetAddr + ".222"},
						{MAC: "02:00:AA:AA:AC:23", IP: NetAddr + ".223"},
						{MAC: "02:00:AA:AA:AC:24", IP: NetAddr + ".224"},
						{MAC: "02:00:AA:AA:AC:25", IP: NetAddr + ".225"},
						{MAC: "02:00:AA:AA:AC:26", IP: NetAddr + ".226"},
						{MAC: "02:00:AA:AA:AC:27", IP: NetAddr + ".227"},
						{MAC: "02:00:AA:AA:AC:28", IP: NetAddr + ".228"},
						{MAC: "02:00:AA:AA:AC:29", IP: NetAddr + ".229"},
						{MAC: "02:00:AA:AA:AC:30", IP: NetAddr + ".230"},
						{MAC: "02:00:AA:AA:AC:31", IP: NetAddr + ".231"},
						{MAC: "02:00:AA:AA:AC:32", IP: NetAddr + ".232"},
						{MAC: "02:00:AA:AA:AC:33", IP: NetAddr + ".233"},
						{MAC: "02:00:AA:AA:AC:34", IP: NetAddr + ".234"},
						{MAC: "02:00:AA:AA:AC:35", IP: NetAddr + ".235"},
						{MAC: "02:00:AA:AA:AC:36", IP: NetAddr + ".236"},
						{MAC: "02:00:AA:AA:AC:37", IP: NetAddr + ".237"},
						{MAC: "02:00:AA:AA:AC:38", IP: NetAddr + ".238"},
						{MAC: "02:00:AA:AA:AC:39", IP: NetAddr + ".239"},
						{MAC: "02:00:AA:AA:AC:40", IP: NetAddr + ".240"},
						{MAC: "02:00:AA:AA:AC:41", IP: NetAddr + ".241"},
						{MAC: "02:00:AA:AA:AC:42", IP: NetAddr + ".242"},
						{MAC: "02:00:AA:AA:AC:43", IP: NetAddr + ".243"},
						{MAC: "02:00:AA:AA:AC:44", IP: NetAddr + ".244"},
						{MAC: "02:00:AA:AA:AC:45", IP: NetAddr + ".245"},
						{MAC: "02:00:AA:AA:AC:46", IP: NetAddr + ".246"},
						{MAC: "02:00:AA:AA:AC:47", IP: NetAddr + ".247"},
						{MAC: "02:00:AA:AA:AC:48", IP: NetAddr + ".248"},
						{MAC: "02:00:AA:AA:AC:49", IP: NetAddr + ".249"},
						{MAC: "02:00:AA:AA:AC:50", IP: NetAddr + ".250"},
						{MAC: "02:00:AA:AA:AC:51", IP: NetAddr + ".251"},
						{MAC: "02:00:AA:AA:AC:52", IP: NetAddr + ".252"},
						{MAC: "02:00:AA:AA:AC:53", IP: NetAddr + ".253"},
						{MAC: "02:00:AA:AA:AC:54", IP: NetAddr + ".254"},
					},
				},
			},
		},
	}
	netxml, err := netcfg.Marshal()
	if err != nil {
		fmt.Println("Network XML convert err : ", err)
		os.Exit(99)
	}
	return netxml
}

func GetCFG() (Datadir string, NetAddr string) {
	virtGoCFG, err := os.ReadFile("/etc/virt-go/virt-go.cfg")
	if err != nil {
		log.Fatal(err)
	}
	cfgString := string(virtGoCFG)
	SplitString := strings.Split(cfgString, "\n")
	Datadir = strings.TrimLeft(SplitString[0], "Datadir=")
	NetAddr = strings.TrimLeft(SplitString[1], "NetAddr=")

	return Datadir, NetAddr
}
